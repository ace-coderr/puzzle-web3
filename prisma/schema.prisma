generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int      @id @default(autoincrement())
  customId      String   @default(uuid())
  walletAddress String   @unique
  balance       Decimal  @default(0.0) @db.Decimal(18, 8)

  gameResults   GameResult[]
  bids          Bid[]
  rewards       Reward[]
  transactions  Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([walletAddress])
}

model GameResult {
  gameId     String  @id @default(cuid())
  userId     Int
  user       User    @relation(fields: [userId], references: [id])

  moves      Int     @default(0)
  score      Int     @default(0)
  bidding    Decimal @db.Decimal(18, 8)
  won        Boolean @default(false)
  difficulty String  @default("medium")

  reward     Decimal? @db.Decimal(18, 8)

  bid         Bid?
  rewardEntry Reward? @relation("GameResultReward")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@index([won])
}

model Bid {
  id            String @id @default(cuid())
  gameResultId  String @unique
  gameResult    GameResult @relation(fields: [gameResultId], references: [gameId])

  userId        Int
  user          User   @relation(fields: [userId], references: [id])

  amount        Decimal @db.Decimal(18, 8)
  status        String  @default("PENDING")
  txSignature   String?

  transactions  Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gameResultId])
  @@index([userId])
  @@index([createdAt])
}

model Reward {
  id            String  @id @default(cuid())
  gameResultId  String  @unique
  gameResult    GameResult @relation("GameResultReward", fields: [gameResultId], references: [gameId])

  userId        Int
  user          User    @relation(fields: [userId], references: [id])

  title         String
  description   String?
  amount        Decimal @db.Decimal(18, 8)

  claimed       Boolean @default(false)
  claimedAt     DateTime?

  createdAt DateTime @default(now())

  @@index([gameResultId])
  @@index([userId])
  @@index([claimed])
}

model Transaction {
  id          Int      @id @default(autoincrement())
  userId      Int
  bidId       String? // <-- FIXED (Bid.id is STRING)
  amount      Decimal   @db.Decimal(65, 30)
  type        String
  status      String
  txSignature String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  bid  Bid? @relation(fields: [bidId], references: [id])
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  BID
  WIN
  LOSE
  REWARD
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}